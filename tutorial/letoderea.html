<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Letoderea | ArcletProject</title>
    <meta name="description" content="Document for ArcletProject">
    <meta name="generator" content="VitePress v1.6.4">
    <link rel="preload stylesheet" href="/assets/style.mc2iNrd1.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.WH2vIgAc.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.Bx98Lnr7.js">
    <link rel="modulepreload" href="/assets/chunks/framework.BpueaGv1.js">
    <link rel="modulepreload" href="/assets/tutorial_letoderea.md.DIO-LhO-.lean.js">
    <link rel="icon" href="/logo.png">
    <meta name="theme-color" content="#2564c2">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-fcbfc0e0></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-fcbfc0e0>Skip to content</a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar" data-v-7ad780c2 data-v-9fd4d1dd><div class="wrapper" data-v-9fd4d1dd><div class="container" data-v-9fd4d1dd><div class="title" data-v-9fd4d1dd><div class="VPNavBarTitle has-sidebar" data-v-9fd4d1dd data-v-9f43907a><a class="title" href="/" data-v-9f43907a><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.svg" alt data-v-ab19afbb><!--]--><span data-v-9f43907a>ArcletProject</span><!--[--><!--]--></a></div></div><div class="content" data-v-9fd4d1dd><div class="content-body" data-v-9fd4d1dd><!--[--><!--]--><div class="VPNavBarSearch search" data-v-9fd4d1dd><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-9fd4d1dd data-v-afb2845e><span id="main-nav-aria-label" class="visually-hidden" data-v-afb2845e> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/tutorial/intro.html" tabindex="0" data-v-afb2845e data-v-815115f5><!--[--><span data-v-815115f5>入门</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-afb2845e data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-bfe7971f><span class="text" data-v-bfe7971f><!----><span data-v-bfe7971f>深入</span><span class="vpi-chevron-down text-icon" data-v-bfe7971f></span></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><div class="items" data-v-20ed86d6><!--[--><!--[--><div class="VPMenuLink" data-v-20ed86d6 data-v-7eeeb2dc><a class="VPLink link" href="/appendices/WIP.html" data-v-7eeeb2dc><!--[--><span data-v-7eeeb2dc>开发指南</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-9fd4d1dd data-v-3f90c1a5><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-3f90c1a5 data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-9fd4d1dd data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ArcletProject" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-9fd4d1dd data-v-f953d92f data-v-bfe7971f><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-bfe7971f><span class="vpi-more-horizontal icon" data-v-bfe7971f></span></button><div class="menu" data-v-bfe7971f><div class="VPMenu" data-v-bfe7971f data-v-20ed86d6><!----><!--[--><!--[--><!----><div class="group" data-v-f953d92f><div class="item appearance" data-v-f953d92f><p class="label" data-v-f953d92f>黑暗模式</p><div class="appearance-action" data-v-f953d92f><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-f953d92f data-v-be9742d9 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-be9742d9></span><span class="vpi-moon moon" data-v-be9742d9></span><!--]--></span></span></button></div></div></div><div class="group" data-v-f953d92f><div class="item social-links" data-v-f953d92f><div class="VPSocialLinks social-links-list" data-v-f953d92f data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ArcletProject" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-60a9a2d3><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-9fd4d1dd data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-9fd4d1dd><div class="divider-line" data-v-9fd4d1dd></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>目录</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-6b867909><button data-v-6b867909>回到顶部 ▲</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-42c4c606><div class="curtain" data-v-42c4c606></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-42c4c606><span class="visually-hidden" id="sidebar-aria-label" data-v-42c4c606> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0" data-v-51288d80 data-v-0009425e><!----><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/intro.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>概览</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-51288d80><section class="VPSidebarItem level-0 has-active" data-v-51288d80 data-v-0009425e><div class="item" role="button" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><h2 class="text" data-v-0009425e>教程</h2><!----></div><div class="items" data-v-0009425e><!--[--><section class="VPSidebarItem level-1 collapsible collapsed" data-v-0009425e data-v-0009425e><div class="item" role="button" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><h3 class="text" data-v-0009425e>Alconna</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0009425e><span class="vpi-chevron-right caret-icon" data-v-0009425e></span></div></div><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-2 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/alconna/v1.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>1.8</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/alconna/v2.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>2.0</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-0009425e data-v-0009425e><div class="item" role="button" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><h3 class="text" data-v-0009425e>NEPattern</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-0009425e><span class="vpi-chevron-right caret-icon" data-v-0009425e></span></div></div><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-2 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/nepattern/v0.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>0.6</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/nepattern/v1.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>1.0</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/cithun.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Cithun</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/letoderea.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Letoderea</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" tabindex="0" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/entari/index.html" data-v-0009425e><!--[--><h3 class="text" data-v-0009425e>Entari</h3><!--]--></a><!----></div><div class="items" data-v-0009425e><!--[--><div class="VPSidebarItem level-2 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/entari/server.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>服务器</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/entari/database.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>数据库</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-0009425e data-v-0009425e><div class="item" data-v-0009425e><div class="indicator" data-v-0009425e></div><a class="VPLink link link" href="/tutorial/tarina.html" data-v-0009425e><!--[--><p class="text" data-v-0009425e>Tarina</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cb998dce data-v-f610f197><div class="content" data-v-f610f197><div class="outline-marker" data-v-f610f197></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-f610f197>目录</div><ul class="VPDocOutlineItem root" data-v-f610f197 data-v-53c99d69><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _tutorial_letoderea external-link-icon-enabled" data-v-e6f2a212><div><h1 id="letoderea" tabindex="-1">Letoderea <a class="header-anchor" href="#letoderea" aria-label="Permalink to &quot;Letoderea&quot;">​</a></h1><p><a href="https://github.com/ArcletProject/Letoderea" target="_blank" rel="noreferrer"><code>Letoderea</code></a> 是 <code>Arclet Project</code> 下负责事件系统与依赖注入的模块，是 <code>Arclet</code> 的核心模块之一。</p><p><code>Letoderea</code> 旨在提供一种简单的方式，使得开发者可以在不了解事件系统的情况下，也能够轻松地进行事件的监听与处理。</p><h2 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h2><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-516Ne" id="tab-D6deSr_" checked><label data-title="pdm" for="tab-D6deSr_">pdm</label><input type="radio" name="group-516Ne" id="tab--0rTWzu"><label data-title="uv" for="tab--0rTWzu">uv</label><input type="radio" name="group-516Ne" id="tab-LdTYQtO"><label data-title="pip" for="tab-LdTYQtO">pip</label></div><div class="blocks"><div class="language-bash vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pdm</span><span style="--shiki-light:#2B5581;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;arclet-letoderea&quot;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">uv</span><span style="--shiki-light:#2B5581;--shiki-dark:#98C379;"> add</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;arclet-letoderea&quot;</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">pip</span><span style="--shiki-light:#2B5581;--shiki-dark:#98C379;"> install</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;arclet-letoderea&quot;</span></span></code></pre></div></div></div><h2 id="基本用法" tabindex="-1">基本用法 <a class="header-anchor" href="#基本用法" aria-label="Permalink to &quot;基本用法&quot;">​</a></h2><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make_event</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> TestEvent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> _</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">value</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>上述代码实现了一个简单的功能：当 <code>TestEvent</code> 事件被触发时，打印出事件的 <code>value</code> 值。 如你所见，<code>on</code> 方法监听了一个事件，传入的参数表示监听事件的类型，而通过装饰器形式，我们注册了 一个该事件的订阅者（通常称为回调函数）。</p><p>所有订阅者函数的参数都被视为依赖注入的声明。在这个例子中，我们声明该订阅者的依赖参数为 <code>value: int</code>， 这意味着当事件被触发时，其属性 <code>value</code> 会自动对应到订阅者的 <code>value</code> 参数。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>make_event</code> 在这里至关重要。它会将装饰的事件类包装为 <code>dataclass</code>, 读取表示事件的类中声明的属性，并生成对应的规则来进行依赖注入。</p></div><h2 id="监听事件" tabindex="-1">监听事件 <a class="header-anchor" href="#监听事件" aria-label="Permalink to &quot;监听事件&quot;">​</a></h2><p>在上面的例子中，我们已经了解到事件系统的基本用法：通过 <code>on</code> 方法注册一个事件的订阅者。 <code>on</code> 方法的签名如下：</p><details class="details custom-block"><summary>函数签名</summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> on</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    event</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> type</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    func</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Callable</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">...</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Any</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> |</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    priority</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    providers</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> TProviders </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    propagators</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> list</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">Propagator</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> |</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    once</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> bool</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> False</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    skip_req_missing</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> bool</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> |</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><code>event</code>：事件的类型，表示监听的事件。</li><li><code>func</code>：订阅者函数，即回调函数。当传入 <code>None</code> 时，表示将用装饰器形式来注册订阅者。</li><li><code>priority</code>：订阅者的优先级，数值越小，优先级越高。</li><li><code>providers</code>：自定义的额外依赖注入提供者。通常而言，我们不需要传入这个参数。</li><li><code>propagators</code>：订阅者的传播者列表。通常而言，我们不需要传入这个参数。 <ul><li>传播者是指在订阅者函数执行前或执行后，自动执行的同级订阅者函数。通过传播者，我们可以实现类似于中间件的功能。</li><li>传播者的定义和注册将在后续章节中介绍。</li></ul></li><li><code>once</code>：是否为临时订阅者。临时订阅者在事件被触发后会将自动注销。</li><li><code>skip_req_missing</code>：是否在依赖缺失时跳过该订阅者。当传入 <code>None</code> 时，表示使用全局配置。</li></ul></details><p>无论是通过装饰器还是函数形式，<code>on</code> 都会返回一个 <code>Subscriber</code> 对象。我们着重关注这个对象的 <code>dispose</code> 方法：调用该方法可以取消订阅。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">subscriber </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(TestEvent, </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">value</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">dispose</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 取消订阅</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="发布者-publisher" tabindex="-1">发布者(Publisher) <a class="header-anchor" href="#发布者-publisher" aria-label="Permalink to &quot;发布者(Publisher)&quot;">​</a></h3><p>在 <code>Letoderea</code> 中，事件会有一个对应的发布者。通常情况下，我们不需要手动创建发布者，而是通过 <code>define</code> 方法来为某一事件定义发布者。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> TestEvent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">test_pub </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">define</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(TestEvent, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">name</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;test&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>make_event</code> 会自动调用 <code>define</code> 方法，因此我们通常只需要用 <code>make_event</code> 来装饰目标事件类。</p></div><p>每个发布者都有一个唯一的名称 (name)，用于标识该发布者。未指定名称时，发布者会使用事件的类名作为名称。</p><h3 id="use-方法" tabindex="-1"><code>use</code> 方法 <a class="header-anchor" href="#use-方法" aria-label="Permalink to &quot;`use` 方法&quot;">​</a></h3><p><code>use</code> 方法是 <code>on</code> 方法的一个变种，它使用 <code>Publisher.id</code> 来指定监听的事件。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">pub </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">define</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(TestEvent, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">name</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;test&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">sub1 </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">use</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(pub, </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">value</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">sub2 </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">use</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;test&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">value</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="warning custom-block github-alert"><p class="custom-block-title">未实装的功能</p><p><code>use</code> 方法传入字符串作为发布者标识时，允许使用 glob 模式进行匹配：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">use</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;test.*&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received all test </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">value</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></div><h3 id="on-global-方法" tabindex="-1"><code>on_global</code> 方法 <a class="header-anchor" href="#on-global-方法" aria-label="Permalink to &quot;`on_global` 方法&quot;">​</a></h3><p><code>on_global</code> 方法是 <code>on</code> 方法的一个变种。由其注册的订阅者将会监听所有事件，而不仅仅是特定的事件类型。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on_global</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> global_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">event</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Global Subscriber: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">event</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="触发事件" tabindex="-1">触发事件 <a class="header-anchor" href="#触发事件" aria-label="Permalink to &quot;触发事件&quot;">​</a></h2><p>事件的触发通过 <code>publish</code>, <code>post</code> 或 <code>waterfall</code> 方法来实现。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">await</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">publish</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">result </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> await</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">post</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> res </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">waterfall</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>publish: 异步地并行触发该事件的所有订阅者。</li><li>post: 异步地触发该事件的所有订阅者，当有其中一个订阅者返回了 <code>None</code> 以外的值时，将这个值作为结果返回。</li><li>waterfall: 异步地串行触发该事件的所有订阅者。</li></ul><p>使用 <code>post</code> 时，若事件满足 <code>Resultable</code> 协议：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Resultable</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(Protocol</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">T</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> check_result</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Any) </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Result</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">T</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> |</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>则 <code>post</code> 方法会返回的 <code>Result</code> 对象将拥有对应的类型提示。同时，订阅者的返回值也将调用 <code>check_result</code> 来进行校验。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>post</code> 和 <code>publish</code> 方法是同步的，它们的返回值是 <code>asyncio.Task</code> 对象。这意味着，你可以在某些同步的代码中进行事件的触发。</p></div><h3 id="轮询事件" tabindex="-1">轮询事件 <a class="header-anchor" href="#轮询事件" aria-label="Permalink to &quot;轮询事件&quot;">​</a></h3><p><code>Letoderea</code> 还提供了轮询事件的功能。该功能通过 <code>setup_fetch()</code> 启用。</p><p>启用后，<code>Letoderea</code> 会自动轮询所有发布者，并将获取到的事件分发给对应的订阅者。</p><h2 id="依赖注入" tabindex="-1">依赖注入 <a class="header-anchor" href="#依赖注入" aria-label="Permalink to &quot;依赖注入&quot;">​</a></h2><p><code>Letoderea</code> 的核心功能之一是依赖注入。通过在订阅者函数的参数中声明依赖，<code>Letoderea</code> 可以自动解析并提供这些依赖。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make_event</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> TestEvent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">await</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">publish</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">bar</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Output: Received foo: Hello, bar: 42</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><code>Letoderea</code> 默认会提供两个依赖：</p><ul><li><code>event</code>：事件本身。注入方式要求<strong>参数名必须为 <code>event</code></strong>，类型不限制。</li><li><code>context: Contexts</code>：一个上下文对象，包含了所有的依赖和事件信息。注入方式要求<strong>参数类型必须为 <code>Contexts</code></strong>，名称不限。</li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>Contexts</code> 是一个字典对象，支持通过键访问依赖。</p><p>对于每一个订阅者函数，其使用的 <code>Contexts</code> 实例都是独立的。</p></div><p>若只使用 <code>Contexts</code>, 由于类型不明确，我们可以通过 <code>CtxItem</code> 来标记一个上下文项，以提供类型提示。</p><details class="details custom-block"><summary>定义上下文项</summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make_event</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> TestEvent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">TEST_FOO</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">CtxItem</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">TEST_BAR</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">CtxItem</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;bar&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">Contexts):</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">TEST_FOO</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # type: str</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    bar </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">TEST_BAR</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # type: int</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></details><h3 id="依赖收集" tabindex="-1">依赖收集 <a class="header-anchor" href="#依赖收集" aria-label="Permalink to &quot;依赖收集&quot;">​</a></h3><p>当目标事件确认传递给订阅者后，一个 <code>Contexts</code> 类的实例将会被创建。这个实例会收集所有的依赖，并在订阅者函数执行时传递给它。</p><p>而对于事件类而言，其是通过特定的 <code>gather</code> 方法来提供依赖收集的功能。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MyEvent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> gather</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Contexts) </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">        ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;Hello&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">        ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;bar&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 42</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>除了定义 <code>gather</code> 方法外，我们也可以在调用 <code>define</code> 时传入 <code>supplier</code> 参数，或使用 <code>@gather</code> 装饰器来注册一个依赖收集方法。这对于目标事件属于<strong>第三方库或无法修改</strong>的情况非常有用。</p><details class="details custom-block"><summary>为 <code>int</code> 定义依赖收集</summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">gather</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> gather_integer</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">target</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Contexts):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;value&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> target</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> integer_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received integer: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">value</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></details><h3 id="依赖提供" tabindex="-1">依赖提供 <a class="header-anchor" href="#依赖提供" aria-label="Permalink to &quot;依赖提供&quot;">​</a></h3><p>收集依赖完成后，我们还需要确定 <code>Contexts</code> 中的依赖与订阅者函数的参数之间的映射关系。<code>Letoderea</code> 提供了 <code>Provider</code> 类来实现这一功能。</p><details class="details custom-block"><summary>定义一个 <code>Provider</code></summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Provider</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Param</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make_event</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> FooEvent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> FooProvider</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(Provider</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> validate</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> param</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Param):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> param</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">name </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;foo&quot;</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;"> __call__</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Contexts) </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Foo2Provider</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(Provider</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> validate</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> param</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Param):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> param</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">name </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;foo2&quot;</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;"> __call__</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Contexts) </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> *</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">FooEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> foo_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> foo2</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    assert</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;Hello&quot;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    assert</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> foo2 </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;HelloHello&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></details><p>如上所示，我们定义了一个 <code>FooProvider</code>，它基本上只需要实现 <code>validate</code> 和 <code>__call__</code> 方法。</p><ul><li><code>validate</code> 方法用于判断当前的参数是否符合绑定条件。 <ul><li><code>param</code> 参数是一个 <code>Param</code> 对象，包含了订阅者函数的参数的信息：名称、类型、默认值和当前参数是否已有绑定。</li></ul></li><li><code>__call__</code> 方法用于返回依赖的值。你可以在这个方法中对原始值进行处理或转换。</li></ul><p>除了继承 <code>Provider</code> 类外，我们还可以使用 <code>provide</code> 函数来生成一个 <code>Provider</code> 实例。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> provide</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo_provider </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> provide</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">target</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">call</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: ctx[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo2_provider </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> provide</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">target</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo2&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">call</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: ctx[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>有些情况下，我们会需要 <code>Param</code> 的信息来生成依赖的值，而正常的 <code>Provider</code> 是无法存储这些信息的。</p><p>此时，我们可以使用 <code>ProviderFactory</code>, 在 <code>validate</code> 方法中返回特定的 <code>Provider</code> 实例。</p><details class="details custom-block"><summary>使用 <code>ProviderFactory</code></summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> ProviderFactory</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Param</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">make_event</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MyEvent</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MyFactory</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">ProviderFactory</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> validate</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> param</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Param):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> param</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">name</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">startswith</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;int_&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">provide</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">target</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">param.name, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">call</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: ctx[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;value&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> param</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">name</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">startswith</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;str_&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">provide</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">target</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">param.name, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">call</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(ctx[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;value&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">MyEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> providers</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">MyFactory</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> my_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">int_value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> str_value</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    assert</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> int_value </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 42</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    assert</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> str_value </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;42&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></details><p>无论是 <code>Provider</code> 还是 <code>ProviderFactory</code>，它们都应该</p><ul><li>在事件类内部定义</li><li>声明事件类的类属性 <code>providers</code>, 例如 <code>providers = [FooProvider, Foo2Provider]</code></li><li>在 <code>on</code> 方法中通过 <code>providers</code> 参数传入。</li><li>对于 <code>Publisher</code> 和 <code>Scope</code>, 通过 <code>bind</code> 方法绑定，以传递给适用的订阅者。</li></ul><h3 id="子依赖" tabindex="-1">子依赖 <a class="header-anchor" href="#子依赖" aria-label="Permalink to &quot;子依赖&quot;">​</a></h3><p>在依赖注入系统中，我们可以定义一个子依赖，来执行自定义的操作，提高代码复用性以及处理性能。</p><p>子依赖使用 <code>Depends</code> 标记进行定义。其传入的参数将同样被解析为一个订阅者函数，接受系统的依赖注入。</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-Nzekj" id="tab-RjBjnUf" checked><label data-title="用 Depends" for="tab-RjBjnUf">用 Depends</label><input type="radio" name="group-Nzekj" id="tab-RAIrkGe"><label data-title="用 @depends" for="tab-RAIrkGe">用 @depends</label><input type="radio" name="group-Nzekj" id="tab-JLk9lrg"><label data-title="配合 Annotated" for="tab-JLk9lrg">配合 Annotated</label></div><div class="blocks"><div class="language-python vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> handle_foo_bar</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> test_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">msg</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Depends</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(handle_foo_bar)</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(msg)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Foo: Hello, Bar: 42</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">depends</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> handle_foo_bar</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> test_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">msg</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> handle_foo_bar):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(msg)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Foo: Hello, Bar: 42</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> typing </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Annotated</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">depends</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> handle_foo_bar</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> test_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">msg</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Annotated</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> handle_foo_bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(msg)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Foo: Hello, Bar: 42</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></div></div><p>在上面的代码中，我们使用 <code>Depends</code> 标记定义了一个子依赖 <code>handle_foo_bar</code>，它接受 <code>foo</code> 和 <code>bar</code>，并返回一个字符串。然后，我们在订阅者函数中使用该子依赖来获取处理后的结果。</p><p>通过将 <code>Depends</code> 包裹的子依赖作为参数的默认值或 Annotated，我们就可以在执行事件处理函数之前执行子依赖，并将其返回值作为参数传入事件处理函数。子依赖和普通的事件处理函数并没有区别，同样可以使用依赖注入，并且可以返回任何类型的值。</p><p>子依赖执行后，其结果会被保存在 <code>Contexts</code> 中。当我们在声明子依赖时，会有一个 <code>cache</code> 参数，用于指定多次使用同一个子依赖时是否使用缓存。</p><details class="details custom-block"><summary>子依赖缓存</summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> random </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> randint</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> seed</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">seed</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 固定随机数种子，确保每次运行结果相同</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">depends</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">cache</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> random_number</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> randint</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> s1</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">num</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> random_number):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Random number: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">num</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Random number: 2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> s2</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">num</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> random_number):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Random number: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">num</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Random number: 2</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></details><p>在同一个事件的分发过程中，这个随机函数的返回值将会保持一致。 缓存的生命周期与当前接收到的事件相同。接收到事件后，子依赖在首次执行时缓存，在该事件处理完成后，缓存就会被清除。</p><h3 id="带上下文管理的子依赖" tabindex="-1">带上下文管理的子依赖 <a class="header-anchor" href="#带上下文管理的子依赖" aria-label="Permalink to &quot;带上下文管理的子依赖&quot;">​</a></h3><p>有些子依赖可能需要在执行前后进行一些操作，例如资源的获取和释放。这时，我们可以将子依赖定义为一个上下文管理器。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> contextlib </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> asynccontextmanager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@asynccontextmanager</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> _mgr</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">():</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    client </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;"> ...</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    yield</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> client</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    await</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> client</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">aclose</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">client</span><span style="--shiki-light:#D32F2F;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">Depends</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(_mgr)</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="传播" tabindex="-1">传播 <a class="header-anchor" href="#传播" aria-label="Permalink to &quot;传播&quot;">​</a></h2><p>当订阅者被创建后，它可以通过 <code>propagate</code> 方法来注册一个前置或后置的同级订阅传播。</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group---ezf" id="tab-PE_gBdP" checked><label data-title="前置传播" for="tab-PE_gBdP">前置传播</label><input type="radio" name="group---ezf" id="tab-cCG_BTk"><label data-title="后置传播" for="tab-cCG_BTk">后置传播</label></div><div class="blocks"><div class="language-python vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">baz</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;前置传播结果: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">baz</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 前置传播结果: Foo: Hello, Bar: 42</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">prepend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> pre_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;baz&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> post_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">result</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;后置传播结果: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">result</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 后置传播结果: Foo: Hello, Bar: 42</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div></div><p>通过合适的传播定义，我们可以类似于定义<strong>中间件</strong>，在事件处理过程中进行更复杂的操作。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>无论是后置还是前置传播，其基础的依赖环境都是相同的，也即传播者们与主订阅者共享同一个 <code>Contexts</code> 实例、同一份 <code>Provider</code> 列表。</p></div><p><code>propagate</code> 方法的签名如下：</p><details class="details custom-block"><summary>函数签名</summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> propagate</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">    self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    func</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> TTarget</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">Any</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> |</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Propagator </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#ABB2BF;">    *</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    prepend</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> bool</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> False</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    priority</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 16</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    providers</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> TProviders </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">|</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">    once</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> bool</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> False</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):  </span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li><code>func</code>：传播的目标函数或 <code>Propagator</code> 实例。当传入 <code>None</code> 时，表示将用装饰器形式来注册传播者。</li><li><code>prepend</code>：是否为前置传播。默认为 <code>False</code>，表示后置传播。</li><li><code>priority</code>：传播者的优先级，可由此控制传播者的执行顺序。数值越小，优先级越高。</li><li><code>providers</code>：自定义的额外依赖注入提供者。通常而言，我们不需要传入这个参数。</li><li><code>once</code>：是否为临时传播者。临时传播者在事件被触发后会将自动注销。</li></ul></details><p><strong>后置传播</strong>是指在主订阅者函数执行完毕后，再&quot;往下&quot;执行传播者函数。后置传播者函数可以注入主订阅者函数的返回值，并对其进行处理。</p><p><strong>前置传播</strong>是指在主订阅者函数执行之前，先执行传播者函数。前置传播者函数可以对 <code>Contexts</code> 进行修改，或返回一个字典来拓展依赖。</p><h3 id="传播集成" tabindex="-1">传播集成 <a class="header-anchor" href="#传播集成" aria-label="Permalink to &quot;传播集成&quot;">​</a></h3><p>除了传入函数注册传播者外，我们还可以使用 <code>Propagator</code> 类来集成传播者。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Propagator</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> pre_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;baz&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> post_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">result</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;后置传播结果: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">result</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> MyPropagator</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Propagator</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> compose</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        yield</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> pre_subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> True</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        yield</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> post_subscriber</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">baz</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;前置传播结果: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">baz</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> baz</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">MyPropagator</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">())</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><code>Propagator</code> 主要工作就是实现 <code>compose</code> 方法，该方法是一个生成器，用于返回传播者函数和是否为前置传播的标志、优先级等。</p><p>通过 <code>Propagator</code>，我们可以将多个传播者函数组合在一起，以提供便利服务。</p><details class="details custom-block"><summary><code>Cooldown</code> 示例</summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Cooldown</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;">Propagator</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;"> __init__</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> interval</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> float</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">interval </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> interval</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">last_time </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">success </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> True</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> before</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">last_time </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">is</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> not</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> None</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;">            self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">success </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> (datetime</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> -</span><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">last_time)</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">total_seconds</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">interval</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> not</span><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">success</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">                return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;"> STOP</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;last_time&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">last_time</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> after</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;">        self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">last_time </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> datetime</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> compose</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        yield</span><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">before</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> True</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        yield</span><span style="--shiki-light:#24292EFF;--shiki-dark:#E5C07B;"> self</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">after</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> False</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></details><h3 id="传播依赖" tabindex="-1">传播依赖 <a class="header-anchor" href="#传播依赖" aria-label="Permalink to &quot;传播依赖&quot;">​</a></h3><p>订阅传播本身没有无法声明对其他传播的依赖，只能依靠优先级来控制执行顺序。 但如果某个传播需要依赖另一个传播的结果，leto 在执行时会自动识别到该情况并尝试调整执行顺序，以满足依赖关系。</p><p>例如：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> s</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">():</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    pass</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@s</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">prepend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> priority</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> p1</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    executed</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">append</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@s</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">prepend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> priority</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> p2</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;bar&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>由于 <code>p1</code> 依赖了 <code>p2</code> 的结果，leto 会在执行 p1 并识别到依赖缺失后，将 p1 放入等待队列，并先执行 p2 来满足依赖。这样就保证了传播者之间的依赖关系能够被正确处理。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>若一个传播使用的参数是由 Provider 提供的，而该 Provider 会依赖于另一个传播的结果，则需要 Provider 在依赖不满足时抛出 <code>ProviderUnsatisfied</code> 异常，以便 leto 能够正确地调整传播的执行顺序。</p></div><h2 id="特殊返回值" tabindex="-1">特殊返回值 <a class="header-anchor" href="#特殊返回值" aria-label="Permalink to &quot;特殊返回值&quot;">​</a></h2><p>针对订阅者函数，<code>Letoderea</code> 还提供了特殊的返回值：<code>ExitState</code>，其分为 <code>STOP</code> 和 <code>BLOCK</code> 两种。</p><p><strong><code>STOP</code></strong> 在同级传播中尤其有用，它会阻止后续的传播者函数执行。通常用在前置传播中，表示不满足执行条件。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> datetime </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> datetime</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;"> STOP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">prepend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> check_time</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">():</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> datetime</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">hour </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 12</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;"> STOP</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 阻止后续传播者执行</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>上述代码中，如果当前时间在中午12点之前，<code>check_time</code> 函数将返回 <code>STOP</code>，从而阻止后续的传播者函数执行，使得该订阅者只能在中午12点之后被触发。</p><p>而 <strong><code>BLOCK</code></strong> 则会阻止当前事件的传播，表示该事件不应继续被处理。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;"> BLOCK</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> priority</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;"> BLOCK</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 阻止当前事件的传播</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> priority</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> blocked_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):  </span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 此订阅者将不会被触发</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>ExitState 类既是 <code>Enum</code> 也是 <code>Exception</code>，因此可以直接 <code>raise STOP</code>。</p></div><p>更进一步，如果需要同时返回结果并阻止事件传播，可以使用 <code>finish</code> 方法，将结果挂载：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> priority</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;"> BLOCK</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">finish</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # 返回结果，并阻止当前事件的传播</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="中断" tabindex="-1">中断 <a class="header-anchor" href="#中断" aria-label="Permalink to &quot;中断&quot;">​</a></h2><p>在某些情况下，我们可能需要中断当前事件的处理流程，并等待另一个事件的处理结果。</p><p><code>Letoderea</code> 提供了 <code>StepOut</code> 组件来实现这一功能。</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-AYcoP" id="tab-MhwZKOE" checked><label data-title="静态声明" for="tab-MhwZKOE">静态声明</label><input type="radio" name="group-AYcoP" id="tab-sSHgnoD"><label data-title="运行时声明" for="tab-sSHgnoD">运行时声明</label></div><div class="blocks"><div class="language-python vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> step_out</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@step_out</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">OtherEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> block</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> handler</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">msg</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> msg</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;Hello&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">        result </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> await</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> handler</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">wait</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">timeout</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">30</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received result from OtherEvent: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">result</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> step_out</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> handler</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">msg</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> msg</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;Hello&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">        step </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> step_out</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(OtherEvent, handler, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">block</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">        result </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> await</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> step</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">wait</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">timeout</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">30</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received result from OtherEvent: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">result</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></div></div><p>若有需要，<code>StepOut</code> 还支持轮询等待，以进行多轮的事件交互：</p><details class="details custom-block"><summary>多轮交互</summary><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> step_out</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> handler</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">msg</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> msg </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;continue!&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;&lt;&lt;&lt; receive in handler:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&#39;&quot;</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">msg</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;&#39;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;world!&quot;</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> msg </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;end.&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">        print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;&lt;&lt;&lt; receive terminal signal&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> False</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;&lt;&lt;&lt; receive event:&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, msg)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">step </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> step_out</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(OtherEvent, handler, </span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">block</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;Hello&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> step</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">waiting</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">              print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Already waiting for OtherEvent, please wait.&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">              return</span></span>
<span class="line highlighted"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">        async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> for</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> result </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">in</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> step</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">default</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">False</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> result </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">is</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> False</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">                print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received terminal signal, ending interaction.&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">                break</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">            print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received result from OtherEvent: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">result</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></details><h2 id="快捷方式" tabindex="-1">快捷方式 <a class="header-anchor" href="#快捷方式" aria-label="Permalink to &quot;快捷方式&quot;">​</a></h2><p><code>Letoderea</code> 提供了一些快捷方式来简化常见的事件处理模式。</p><h3 id="bind" tabindex="-1"><code>bind</code> <a class="header-anchor" href="#bind" aria-label="Permalink to &quot;`bind`&quot;">​</a></h3><p><code>bind</code> 是注册订阅者时 <code>providers</code> 参数的一个快捷方式，以装饰器形式使用。</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-Li_6R" id="tab-tCj7jly" checked><label data-title="bind" for="tab-tCj7jly">bind</label><input type="radio" name="group-Li_6R" id="tab-RItKun0"><label data-title="对比" for="tab-RItKun0">对比</label></div><div class="blocks"><div class="language-python vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">bind</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">provide</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> target</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> call</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">: ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]))</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> providers</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">provide</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> target</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> call</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">: ctx</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;foo&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">])])</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></div></div><h3 id="propagate" tabindex="-1"><code>propagate</code> <a class="header-anchor" href="#propagate" aria-label="Permalink to &quot;`propagate`&quot;">​</a></h3><p><code>propagate</code> 是 <code>Subscriber.propagate</code> 的一个快捷方式，用于注册传播者。</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-0QgiX" id="tab-sl5ETen" checked><label data-title="propagate" for="tab-sl5ETen">propagate</label><input type="radio" name="group-0QgiX" id="tab--Y6ZIaj"><label data-title="对比" for="tab--Y6ZIaj">对比</label></div><div class="blocks"><div class="language-python vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> pre_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;baz&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">pre_subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> prepend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">baz</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> leto</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">baz</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@subscriber</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">propagate</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">prepend</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">True</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> pre_subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;"> {</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;baz&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></div></div><p>对于前置传播而言, <code>@propagate</code> 会更符合直觉，因为它可以直接在订阅者函数上使用，而不需要额外的 <code>Subscriber</code> 实例。</p><h3 id="过滤器" tabindex="-1">过滤器 <a class="header-anchor" href="#过滤器" aria-label="Permalink to &quot;过滤器&quot;">​</a></h3><p>基于传播机制，<code>Letoderea</code> 还提供了过滤器的功能。过滤器可以在事件处理之前对事件进行筛选。</p><ul><li><code>enter_if</code>：如果事件满足某个条件，则允许当前订阅者执行。</li><li><code>bypass_if</code>：如果事件满足某个条件，则拒绝当前订阅者执行。</li><li><code>allow_event</code>: 如果事件是某个类型，则允许当前订阅者执行。</li><li><code>refuse_event</code>: 如果事件是某个类型，则拒绝当前订阅者执行。</li></ul><p>过滤器可以叠加使用：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> enter_if</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">@</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">enter_if</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> event</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: event.foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;Hello&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> event</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">: event</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>不仅如此，<code>on</code>, <code>use</code> 和 <code>on_global</code> 方法也支持链式声明过滤器：</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#24292EFF;--shiki-dark:#FFFFFF;">.if_(lambda event: event.foo == &quot;Hello&quot;).if_(lambda event: event.bar &gt; 0)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="deref" tabindex="-1"><code>deref</code> <a class="header-anchor" href="#deref" aria-label="Permalink to &quot;`deref`&quot;">​</a></h3><p><code>deref</code> 是针对事件类或注入参数的魔术方法，用于生成对事件或注入参数的属性值的操作。</p><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-cHDHl" id="tab-rO3WZE0" checked><label data-title="依赖注入 - 事件操作" for="tab-rO3WZE0">依赖注入 - 事件操作</label><input type="radio" name="group-cHDHl" id="tab-qLzbrp3"><label data-title="依赖注入 - 参数操作" for="tab-qLzbrp3">依赖注入 - 参数操作</label><input type="radio" name="group-cHDHl" id="tab-6FrVT7u"><label data-title="过滤器" for="tab-6FrVT7u">过滤器</label></div><div class="blocks"><div class="language-python vp-adaptive-theme active line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> typing </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Annotated</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> deref</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">baar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> Annotated</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> deref</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(TestEvent).</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber1</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">baar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> deref</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(TestEvent).</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">bar):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> deref</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber2</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">baar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> deref</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;">int</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;bar&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#24292EFF;--shiki-dark:#D19A66;">    ...</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> deref</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#24292EFF;--shiki-dark:#FFFFFF;"> \</span></span>
<span class="line"><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">if_</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">deref</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(TestEvent).foo </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;"> &quot;Hello&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;"> \</span></span>
<span class="line"><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">    .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">if_</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">deref</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(TestEvent).bar </span><span style="--shiki-light:#D32F2F;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></div></div><p><code>deref</code> 作为过滤器，声明判断条件时，<strong>可以和其他的 deref 或 Depend 结合使用</strong>，以实现更复杂的条件判断。</p><h3 id="defer" tabindex="-1"><code>defer</code> <a class="header-anchor" href="#defer" aria-label="Permalink to &quot;`defer`&quot;">​</a></h3><p><code>defer</code> 是针对后置传播的一层包装，用于注册一个一次性的后置传播者。当事件被触发时，该传播者会在主订阅者函数执行完毕后执行，并在执行后自动注销。</p><div class="language-python vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes min-light one-dark-pro vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">from</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> arclet</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">letoderea </span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;"> defer</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">@leto</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">on</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#212121;--shiki-dark:#61AFEF;">TestEvent</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">async</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;"> def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> subscriber</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;">foo</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> str</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#FF9800;--shiki-light-font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic;"> bar</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#1976D2;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#24292EFF;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    defer</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">lambda</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Deferred: Foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, Bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#56B6C2;">    print</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D32F2F;--shiki-dark:#C678DD;">f</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;Received foo: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">foo</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">, bar: </span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">{</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">bar</span><span style="--shiki-light:#1976D2;--shiki-dark:#D19A66;">}</span><span style="--shiki-light:#22863A;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#212121;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Output:</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Received foo: Hello, bar: 42</span></span>
<span class="line"><span style="--shiki-light:#C2C3C5;--shiki-light-font-style:inherit;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Deferred: Foo: Hello, Bar: 42</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="param" tabindex="-1"><code>param</code> <a class="header-anchor" href="#param" aria-label="Permalink to &quot;`param`&quot;">​</a></h3><p><code>param</code> 是一个特殊的 <code>Depend</code>, 仅用来注入另一个参数。</p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-1bcd8184><!--[--><!--]--><div class="edit-info" data-v-1bcd8184><div class="edit-link" data-v-1bcd8184><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/ArcletProject/Documents/edit/main/tutorial/letoderea.md" target="_blank" rel="noreferrer" data-v-1bcd8184><!--[--><span class="vpi-square-pen edit-link-icon" data-v-1bcd8184></span> 在 GitHub 编辑此页<!--]--></a></div><div class="last-updated" data-v-1bcd8184><p class="VPLastUpdated" data-v-1bcd8184 data-v-1bb0c8a8>上次更新: <time datetime="2026-02-14T05:31:32.000Z" data-v-1bb0c8a8></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-1bcd8184><span class="visually-hidden" id="doc-footer-aria-label" data-v-1bcd8184>Pager</span><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link prev" href="/tutorial/cithun.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>上一页</span><span class="title" data-v-1bcd8184>Cithun</span><!--]--></a></div><div class="pager" data-v-1bcd8184><a class="VPLink link pager-link next" href="/tutorial/entari/index.html" data-v-1bcd8184><!--[--><span class="desc" data-v-1bcd8184>下一页</span><span class="title" data-v-1bcd8184>Entari</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-d8b57b2d data-v-566314d4><div class="container" data-v-566314d4><p class="message" data-v-566314d4>MIT License</p><p class="copyright" data-v-566314d4>Copyright © 2025 ArcletProject</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"appendices_wip.md\":\"DANHohDI\",\"index.md\":\"B1ThGHtK\",\"tutorial_alconna_index.md\":\"CWlMvd-q\",\"tutorial_alconna_v1.md\":\"DcwTnFG6\",\"tutorial_alconna_v2.md\":\"BnhyTQyn\",\"tutorial_cithun.md\":\"BN4P-wQC\",\"tutorial_entari_database.md\":\"82bDDhtt\",\"tutorial_entari_index.md\":\"t0UZr7fd\",\"tutorial_entari_server.md\":\"n5WQgwlO\",\"tutorial_intro.md\":\"BnayZVfR\",\"tutorial_letoderea.md\":\"DIO-LhO-\",\"tutorial_nepattern_index.md\":\"DDW_bORY\",\"tutorial_nepattern_v0.md\":\"DE-vULqs\",\"tutorial_nepattern_v1.md\":\"C2Z4oiwX\",\"tutorial_tarina.md\":\"Bicql5Rj\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"ArcletProject\",\"description\":\"Document for ArcletProject\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"logo\":\"/logo.svg\",\"nav\":[{\"text\":\"入门\",\"link\":\"/tutorial/intro.md\",\"activeMatch\":\"/tutorial/intro.md\"},{\"text\":\"深入\",\"items\":[{\"text\":\"开发指南\",\"link\":\"/appendices/WIP.md\",\"activeMatch\":\"/appendices/WIP.md\"}]}],\"sidebar\":{\"/tutorial/\":[{\"text\":\"\",\"items\":[{\"text\":\"概览\",\"link\":\"/tutorial/intro.md\"}]},{\"text\":\"教程\",\"items\":[{\"text\":\"Alconna\",\"collapsed\":true,\"items\":[{\"text\":\"1.8\",\"link\":\"/tutorial/alconna/v1.md\"},{\"text\":\"2.0\",\"link\":\"/tutorial/alconna/v2.md\"}]},{\"text\":\"NEPattern\",\"collapsed\":true,\"items\":[{\"text\":\"0.6\",\"link\":\"/tutorial/nepattern/v0.md\"},{\"text\":\"1.0\",\"link\":\"/tutorial/nepattern/v1.md\"}]},{\"text\":\"Cithun\",\"link\":\"/tutorial/cithun.md\"},{\"text\":\"Letoderea\",\"link\":\"/tutorial/letoderea.md\"},{\"text\":\"Entari\",\"link\":\"/tutorial/entari/index.md\",\"items\":[{\"text\":\"服务器\",\"link\":\"/tutorial/entari/server.md\"},{\"text\":\"数据库\",\"link\":\"/tutorial/entari/database.md\"}]},{\"text\":\"Tarina\",\"link\":\"/tutorial/tarina.md\"}]}]},\"editLink\":{\"pattern\":\"https://github.com/ArcletProject/Documents/edit/main/:path\",\"text\":\"在 GitHub 编辑此页\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/ArcletProject\"}],\"footer\":{\"message\":\"MIT License\",\"copyright\":\"Copyright © 2025 ArcletProject\"},\"lastUpdated\":{\"text\":\"上次更新\"},\"outline\":{\"label\":\"目录\",\"level\":[2,3]},\"docFooter\":{\"prev\":\"上一页\",\"next\":\"下一页\"},\"search\":{\"provider\":\"local\"},\"darkModeSwitchLabel\":\"黑暗模式\",\"lightModeSwitchTitle\":\"切换到浅色模式\",\"darkModeSwitchTitle\":\"切换到黑暗模式\",\"sidebarMenuLabel\":\"目录\",\"returnToTopLabel\":\"回到顶部 ▲\",\"externalLinkIcon\":true},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>